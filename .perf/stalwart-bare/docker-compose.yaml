# Docker Compose for Stalwart Standalone Performance Testing
# This stack tests Stalwart acting as both MTA and storage backend
# JMeter connects directly to Stalwart's SMTP listener (no Robin/Postfix)

services:
  postgres:
    image: postgres:latest
    container_name: postgres
    command:
      - "postgres"
      - "-c"
      - "logging_collector=on"
      - "-c"
      - "log_directory=/var/log/postgresql"
      - "-c"
      - "log_filename=postgresql.log"
      - "-c"
      - "log_destination=stderr"
    environment:
      POSTGRES_DB: robin
      POSTGRES_USER: robin
      POSTGRES_PASSWORD: robin
      POSTGRES_MAX_CONNECTIONS: 300
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ../.shared/db-init-stalwart/03-create-stalwart-tables.sql:/docker-entrypoint-initdb.d/01-create-stalwart-tables.sql:ro
      - ../.shared/db-init-stalwart/04-create-stalwart-users.sql:/docker-entrypoint-initdb.d/02-create-stalwart-users.sql:ro
      - ../../store/postgres:/var/lib/postgresql
      - ../../log/postgres:/var/log/postgresql
    networks:
      stalwart-bare-net:
        aliases:
          - postgres-backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U robin -d robin"]
      interval: 5s
      timeout: 3s
      retries: 10

  stalwart:
    image: stalwartlabs/stalwart:latest
    container_name: stalwart
    user: "0:0"
    volumes:
      - ./stalwart/etc:/opt/stalwart/etc
      - ../../store/stalwart:/opt/stalwart/data
      - ../../log/stalwart:/var/log
    networks:
      - stalwart-bare-net
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "2525:25"    # SMTP for JMeter
      - "2143:143"   # IMAP for test verification
      - "28082:8080" # HTTP/Web Admin interface
    # Health check disabled - Stalwart container lacks standard tools (nc, ps, wget, curl)
    # Container logs show SMTP/IMAP listeners start successfully

networks:
  stalwart-bare-net:
    driver: bridge

volumes: {}

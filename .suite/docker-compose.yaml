# Docker Compose Suite for Robin MTA + Dovecot + PostgreSQL + ClamAV + Rspamd + Roundcube
# This file sets up a complete end-to-end email infrastructure:
# - Robin MTA (SMTP server)
# - Dovecot (IMAP/LMTP for mailbox hosting)
# - PostgreSQL (user database)
# - ClamAV (virus scanning)
# - Rspamd (spam detection)
# - Roundcube (webmail)
# See .suite/init-suite.sh for initial directory setup on Windows WSL2.
# There is a Docker bug that sometimes may prevent mounting/creating non-existent directories.

services:
  # PostgreSQL database for Robin, Dovecot and Roundcube storage.
  suite-postgres:
    image: postgres:latest
    container_name: suite-postgres
    command:
      - "postgres"
      - "-c"
      - "logging_collector=on"
      - "-c"
      - "log_directory=/var/log"
      - "-c"
      - "log_filename=postgresql-%Y-%m-%d.log"
    environment:
      POSTGRES_DB: robin
      POSTGRES_USER: robin
      POSTGRES_PASSWORD: robin
    volumes:
      - ../log/postgres:/var/log
      - ../store/postgres:/var/lib/postgresql
      - ./db-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5433:5432"  # Using 5433 to avoid conflict with local Postgres.
    networks:
      suite:
        aliases:
          - postgres-backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U robin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ClamAV virus scanner.
  suite-clamav:
    image: clamav/clamav:latest
    platform: linux/amd64
    container_name: suite-clamav
    volumes:
      - ../log/clamav:/var/log/clamav
      - ../store/clamav:/var/lib/clamav
    ports:
      - "3310:3310"
    networks:
      suite:
        aliases:
          - antivirus-backend
    healthcheck:
      test: ["CMD", "/usr/local/bin/clamdcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s  # ClamAV needs time to download virus definitions.

  # Rspamd spam/phishing detection.
  suite-rspamd:
    image: rspamd/rspamd:latest
    platform: linux/amd64
    container_name: suite-rspamd
    volumes:
      - ../log/rspamd:/var/log
      - ../store/rspamd:/var/lib/rspamd
      - ./etc/rspamd/local.d:/etc/rspamd/local.d
    ports:
      - "11333:11333"  # Rspamd normal worker.
      - "11334:11334"  # Rspamd web UI.
    networks:
      suite:
        aliases:
          - spam-backend
    healthcheck:
      test: ["CMD", "rspamadm", "configtest"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Robin MTA server.
  suite-robin:
    container_name: suite-robin
    platform: linux/amd64
    build:
      context: ../
      dockerfile: ./Dockerfile
      args:
        INCLUDE_CFG: "false"
    volumes:
      - ./cfg:/usr/local/robin/cfg
      - ../log/robin:/var/log/robin
      - ../store/robin:/usr/local/robin/store
    depends_on:
      suite-postgres:
        condition: service_healthy
      suite-clamav:
        condition: service_healthy
      # suite-rspamd:
      #   condition: service_healthy
      suite-dovecot:
        condition: service_healthy
    ports:
      - "2525:25"      # SMTP
      - "2587:587"     # SUBMISSION
      - "2465:465"     # SMTPS
      - "28080:8080"   # Service API
      - "28090:8090"   # Client API (logs, queue, store)
    environment:
      - JAVA_TOOL_OPTIONS=-Dnetworkaddress.cache.negative.ttl=300 -Dsun.net.inetaddr.negative.ttl=300 ${JAVA_TOOL_OPTIONS:-}
      - POSTGRES_HOST=postgres-backend
      - POSTGRES_DB=robin
      - POSTGRES_USER=robin
      - POSTGRES_PASSWORD=robin
      - CLAMAV_HOST=antivirus-backend
      - CLAMAV_PORT=3310
      - RSPAMD_HOST=spam-backend
      - RSPAMD_PORT=11333
      - DOVECOT_HOST=lmtp-backend
      - DOVECOT_LMTP_PORT=24
    networks:
      suite:
        aliases:
          - mta-backend
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "25"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dovecot IMAP/LMTP server.
  suite-dovecot:
    image: dovecot/dovecot:latest
    container_name: suite-dovecot
    user: "0:0"
    cap_add:
      - CHOWN
    volumes:
      - ./etc/dovecot:/etc/dovecot:ro
      - ../store/dovecot:/var/mail/vhosts
      - ../log/dovecot:/var/log
    depends_on:
      suite-postgres:
        condition: service_healthy
    ports:
      - "2143:143"     # IMAP
      - "2993:993"     # IMAPS
      - "2110:110"     # POP3
      - "224:24"       # LMTP (for Robin to relay mail to Dovecot)
    environment:
      - POSTGRES_HOST=postgres-backend
      - POSTGRES_DB=robin
      - POSTGRES_USER=robin
      - POSTGRES_PASSWORD=robin
    networks:
      suite:
        aliases:
          - lmtp-backend
          - imap-backend
    healthcheck:
      test: ["CMD", "doveadm", "who"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Roundcube webmail for user access.
  suite-roundcube:
    image: roundcube/roundcubemail:latest
    container_name: suite-roundcube
    depends_on:
      suite-postgres:
        condition: service_healthy
      suite-dovecot:
        condition: service_healthy
    ports:
      - "8888:80"
    environment:
      - ROUNDCUBEMAIL_DB_TYPE=pgsql
      - ROUNDCUBEMAIL_DB_HOST=postgres-backend
      - ROUNDCUBEMAIL_DB_PORT=5432
      - ROUNDCUBEMAIL_DB_USER=robin
      - ROUNDCUBEMAIL_DB_PASSWORD=robin
      - ROUNDCUBEMAIL_DB_NAME=roundcube
      - ROUNDCUBEMAIL_DEFAULT_HOST=imap-backend
      - ROUNDCUBEMAIL_DEFAULT_PORT=143
      - ROUNDCUBEMAIL_SMTP_SERVER=mta-backend
      - ROUNDCUBEMAIL_SMTP_PORT=25
      - ROUNDCUBEMAIL_IMAP_CONN_OPTIONS={"ssl":{"verify_peer":false,"verify_peer_name":false}}
      - ROUNDCUBEMAIL_UPLOAD_MAX_FILESIZE=10M
    networks:
      suite:
        aliases:
          - webmail-backend
    volumes:
      - ../log/roundcube:/var/log

networks:
  suite:
    driver: bridge

# Authentication for Dovecot.

# Allow plaintext authentication.
auth_allow_cleartext = yes

# Supported auth mechanisms.
auth_mechanisms = plain login

# Auth caching to reduce backend lookups.
auth_cache_size = 10M
auth_cache_ttl = 1h
auth_cache_negative_ttl = 15m

# Brute-force mitigation.
auth_failure_delay = 2 secs
login_greeting = Dovecot ready

# Reduce verbosity in production.
auth_verbose = no
auth_debug = no

# Example configurations for passwd-file backend (commented out).
# passdb {
#   driver = passwd-file
#   args = /etc/dovecot/passwd
# }
#
# userdb {
#   driver = static
#   args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n
# }

# SQL backend configuration (inline for Dovecot 2.4+).
# PostgreSQL connection settings.
pgsql robin-suite-postgres {
  parameters {
    user = robin
    password = robin
    dbname = robin
  }
}

sql_driver = pgsql
passdb_default_password_scheme = SHA512-CRYPT

# Deterministic prioritized lookup with LEFT JOINs and CASE ordering.
# Priority: 1 = direct user match, 2 = aliases, 3 = auto_aliases.
passdb sql {
  query = SELECT u.email AS user, u.password AS password FROM users u \
    LEFT JOIN aliases a ON a.destination = u.email \
    LEFT JOIN auto_aliases aa ON aa.destination = u.email \
    WHERE u.email = '%{user}' OR a.source = '%{user}' OR aa.source = '%{user}' \
    ORDER BY CASE WHEN u.email = '%{user}' THEN 1 WHEN a.source = '%{user}' THEN 2 WHEN aa.source = '%{user}' THEN 3 ELSE 4 END \
    LIMIT 1
}

# Userdb lookup with the same deterministic priority.
userdb sql {
  query = SELECT u.home AS home, u.uid AS uid, u.gid AS gid, u.maildir AS mail FROM users u \
    LEFT JOIN aliases a ON a.destination = u.email \
    LEFT JOIN auto_aliases aa ON aa.destination = u.email \
    WHERE u.email = '%{user}' OR a.source = '%{user}' OR aa.source = '%{user}' \
    ORDER BY CASE WHEN u.email = '%{user}' THEN 1 WHEN a.source = '%{user}' THEN 2 WHEN aa.source = '%{user}' THEN 3 ELSE 4 END \
    LIMIT 1
}
